import numpy as np
import theano
import theano.tensor as T
import sys

sys.path.append('../nn')

from BatchNormLayer import BatchNormLayer

N  = 4
n_out = 4

x = np.array(np.arange(N*n_out).reshape(N, n_out), dtype='float32')
norm_x = (x - x.mean((0,), keepdims=True)) / x.std((0,), keepdims=True)

t_x = T.fmatrix('x')
t_bn = BatchNormLayer((N, n_out))
t_f = theano.function([t_x], t_bn(t_x))

# Test case 1: Batchnorm with shifting = 0 and scaling = 1 on 2D-Tensor
t_norm_x = t_f(x)
assert (t_norm_x == norm_x).all(), (
    'BatchNormLayer gives incorrect result for Test case 1. '
    'Correct output is {0} but returned output is {1}.'
    .format(norm_x, t_f(x))
)

# reset beta, gamma
batch_size = 2
channels   = 2
rows       = 2
cols       = 2
t_bn2 = BatchNormLayer((batch_size, channels, rows, cols))

x2 = np.array(np.arange(batch_size*channels*rows*cols).reshape(
             batch_size, channels, rows, cols), dtype='float32')

t_x2 = T.ftensor4('x2')

t_f2 = theano.function([t_x2], t_bn2(t_x2))

norm_x = (x - x.mean((0,), keepdims=True)) / x.std((0,), keepdims=True)

## Test case 2: Batchnorm with shifting = 0 and scaling = 1 on 4D-Tensor
t_norm_x = t_f(x)
assert (t_norm_x == norm_x).all(), (
    'BatchNormLayer gives incorrect result for Test case 2. '
    'Correct output is {0} but returned output is {1}.'
    .format(norm_x, t_f(x)))

N  = 1
n_out = 500

# Test case 1: Batchnorm with a batchsize of 1, ought to not change the input
t_x = T.fmatrix('x')
t_bn = BatchNormLayer((N, n_out))
t_f = theano.function([t_x], t_bn(t_x), allow_input_downcast=True)

test = np.array([[-2.03667763e-02,  6.23429254e-02,  2.11436058e-03,  2.49102141e-02,
                   2.67801916e-02, -9.92374864e-03, -3.92246253e-02, -1.42136518e-02,
                  -7.21000503e-03,  2.93298595e-02,  4.63657792e-03,  3.14714360e-02,
                   1.91655688e-03, -4.26007139e-02,  6.13475043e-03,  1.87667456e-02,
                  -8.97965062e-03, -7.16327773e-03, -8.88628026e-03, -1.67929601e-02,
                   2.03558460e-02, -2.10210500e-02, -2.52249490e-03, -7.39817425e-03,
                  -2.57225276e-02, -1.75197138e-02,  1.12962620e-02, -9.71247753e-04,
                  -3.22364698e-02, -1.86329984e-03,  1.47980525e-02,  1.48094534e-02,
                  -1.10863125e-02, -5.25967714e-03, -1.37054688e-02, -3.90468021e-02,
                  -3.12526807e-03, -8.53158883e-03, -2.10095944e-03, -4.28678660e-02,
                   5.21018054e-04,  2.58266714e-02,  2.21094245e-02, -2.87695079e-02,
                   2.50745674e-03, -2.77871454e-02, -3.30483962e-02, -3.05059391e-02,
                   5.00896352e-02, -3.77156168e-02, -3.30957362e-04, -1.75790548e-02,
                   1.87562433e-02, -1.10501403e-02, -6.60737866e-02,  2.43993805e-02,
                  -1.60306919e-02,  5.77308131e-03, -3.10939192e-02, -3.03690820e-02,
                   9.22706624e-03,  5.84875688e-02,  3.92817317e-02,  1.29745399e-02,
                   3.21066230e-02, -4.04743359e-02,  4.31493111e-02,  1.53210880e-03,
                   2.11258000e-02,  1.98386745e-02,  3.57556125e-02, -7.34663821e-03,
                  -5.88885172e-03,  3.38360950e-02,  1.19356970e-02, -8.15844068e-03,
                   1.59921783e-02, -1.29794344e-03,  3.41030900e-04, -1.47366260e-02,
                   2.20799909e-02, -1.25022856e-02, -1.36396061e-02, -6.76903295e-03,
                   1.80073783e-02, -5.88270016e-04,  6.42953462e-03, -4.16990110e-03,
                  -1.68443785e-02,  1.62077618e-02, -1.53861564e-02, -1.35596009e-02,
                   3.13036169e-03,  4.55258996e-02, -7.70274739e-03, -4.99651682e-02,
                   2.69393462e-02,  3.34011739e-03,  1.45652528e-02, -4.76032010e-02,
                   1.05707469e-02,  1.06787788e-05,  2.88792782e-02,  1.22323443e-02,
                  -9.10810853e-03, -5.63810483e-02, -2.27643557e-03,  5.18438211e-02,
                  -9.11374180e-03,  2.70273479e-02, -3.09504797e-02,  8.73435978e-03,
                  -3.69318609e-02, -2.97761489e-03,  4.44148200e-02,  3.63840714e-02,
                  -2.45263207e-02,  1.42738635e-02, -5.98717700e-03, -1.38080985e-02,
                   3.16193219e-02,  2.54588189e-02, -2.20689155e-02, -2.51398964e-02,
                   5.57484362e-03, -1.69754440e-02,  1.13849969e-02,  1.87117418e-02,
                  -2.92849582e-03,  3.17676455e-02, -1.27369787e-03,  1.51799288e-02,
                  -3.41928573e-02, -1.40540055e-02, -2.39122294e-02,  8.21571005e-03,
                   5.35138915e-04, -2.00093815e-03, -3.28656737e-02, -2.33104513e-02,
                   4.44714495e-03, -1.65719083e-02,  1.73108998e-02,  1.03405420e-02,
                   1.60432854e-02, -1.52702639e-02, -1.55888583e-02,  9.49024275e-03,
                  -3.38229314e-03,  1.20268941e-03, -6.23049948e-03, -2.98502377e-02,
                   4.34183388e-02, -7.05488763e-04, -5.49214526e-03,  3.28604881e-02,
                  -2.85106623e-02, -4.05848517e-02, -2.02184872e-02,  3.60485642e-02,
                  -2.34216012e-03,  1.64526049e-02, -9.72432148e-03, -2.24027255e-02,
                  -3.08130873e-02, -1.72336341e-02, -1.38487438e-02,  3.01608468e-02,
                   2.59186941e-02, -3.01084538e-02,  6.20046221e-03, -3.88758153e-02,
                   2.52969821e-02,  2.55843269e-02, -3.12470517e-02, -3.50437548e-02,
                   1.74027395e-02, -1.06110680e-02,  3.66646678e-02,  2.49016349e-02,
                  -1.17727947e-02, -1.58451294e-02,  1.14979567e-02, -1.30581692e-02,
                   1.42279535e-02,  9.94828816e-03, -1.40189665e-02,  1.29918457e-02,
                   1.56072361e-02,  1.25937424e-02, -3.93707527e-03, -4.17902182e-02,
                  -3.99475993e-02, -1.42933813e-02, -2.23700132e-02, -4.26565694e-02,
                   1.53679955e-02, -1.02108791e-02, -6.05729958e-03, -6.99121198e-03,
                  -2.71995235e-03, -7.55684615e-03,  2.06843914e-02,  1.55244670e-02,
                  -3.03347577e-02,  1.34966593e-02, -8.46906735e-03,  1.09957988e-02,
                   1.47453515e-02, -4.34549990e-02,  1.32036930e-02,  5.15431421e-03,
                  -1.77950801e-02, -8.39820405e-03, -3.97046912e-03,  9.98782340e-03,
                  -3.99719565e-02, -7.78396432e-03,  2.63708516e-02, -2.29209019e-02,
                  -1.77965923e-03, -1.47068781e-02, -4.19836457e-02,  7.93830977e-03,
                   6.05470865e-03,  3.40225560e-02, -2.08104500e-03, -6.57119842e-03,
                  -1.60188597e-02,  2.31058328e-02,  4.67481144e-02,  2.30151315e-02,
                   2.86877664e-02,  8.67372806e-03, -5.58202328e-02, -4.58021174e-03,
                   3.64223701e-02,  4.52597781e-04,  2.90501580e-02, -2.70652971e-03,
                   1.71941764e-02,  2.37277304e-02, -2.97146662e-02, -2.66960465e-02,
                  -4.07770096e-04,  1.53006955e-02,  5.66217211e-03,  1.15725160e-02,
                   3.17075932e-02,  2.01721285e-02,  2.98811457e-03, -2.01249858e-02,
                   2.14510022e-03, -2.06321273e-02, -1.45094216e-02, -3.09182632e-02,
                   5.13829476e-02, -3.60978927e-02, -2.69725845e-02, -3.07643303e-02,
                  -2.07216548e-02, -2.23328928e-02, -2.84762028e-02, -4.87147188e-03,
                  -4.42842602e-03,  4.69778247e-03, -1.90499948e-03, -3.40209964e-02,
                   7.99482769e-03,  1.77456355e-02,  4.45115498e-02,  3.88874002e-02,
                   1.32082246e-02, -1.36539287e-02, -3.72781644e-02,  1.29640014e-02,
                  -2.51295123e-02,  4.52743652e-02, -2.20967733e-02, -1.64662312e-02,
                   4.58720523e-02, -2.00739229e-02, -3.12824148e-02,  4.89728059e-02,
                   2.41313952e-02, -4.39972314e-03,  3.50605437e-02, -9.24889391e-03,
                  -9.19915652e-03,  6.57460445e-02, -1.30641541e-03, -2.50341816e-02,
                  -1.91344713e-02, -1.85199941e-02,  1.16626595e-03, -1.10353927e-02,
                  -3.10406621e-02,  2.57901884e-03,  2.44240633e-02, -6.01212329e-04,
                   4.85810342e-02,  2.51732462e-02, -5.57158830e-03,  2.90265024e-02,
                  -1.92003724e-02, -6.13815745e-03,  1.61960967e-02, -4.76803549e-03,
                  -1.16537062e-02, -1.60825397e-02, -3.56648159e-02,  3.20809387e-02,
                  -4.40391016e-02,  5.40074382e-02,  1.32349625e-02,  1.85629478e-02,
                   6.24604197e-02, -1.37090889e-02,  1.55779115e-03,  3.42589781e-02,
                   1.06288423e-02, -2.21500356e-02, -8.35348931e-03, -2.82802567e-02,
                   2.06364595e-02,  3.71554327e-03, -1.09509163e-02,  9.21025494e-03,
                   1.20552129e-03,  5.57560187e-02, -1.43762713e-02,  8.09889160e-02,
                   1.66175015e-02, -5.56456320e-02,  2.58422845e-02,  3.41735712e-02,
                   1.33441464e-02,  1.20118332e-02,  1.20734423e-02,  1.08670487e-02,
                   1.88086825e-02,  1.23548320e-02,  9.58585217e-03,  8.12267188e-03,
                  -1.87055611e-02,  2.34903444e-02, -2.38172439e-03,  2.03396391e-02,
                   9.78060966e-03, -1.59222365e-02, -8.02464091e-04,  1.31492533e-02,
                   4.36573602e-03,  3.02948382e-02,  4.57820764e-02,  2.38566867e-02,
                  -1.45706788e-02, -1.04566390e-02,  1.73001052e-02,  2.32667996e-02,
                  -2.95791628e-02, -4.04371863e-02,  3.62800556e-02, -1.10879795e-02,
                  -3.20410197e-02,  3.95361478e-02,  7.79422164e-03, -1.88031054e-02,
                  -1.38922715e-02,  8.94169351e-03,  1.68441073e-03, -3.74827871e-02,
                  -3.99290282e-02, -3.03613484e-02,  2.52748857e-02,  2.19971738e-03,
                   3.14063190e-02, -2.51136257e-02,  1.71776218e-02,  7.88720217e-03,
                   1.09625986e-02,  8.57744582e-04, -3.36437829e-02,  4.05840807e-02,
                  -9.99864024e-03,  9.62509033e-03,  2.14976408e-02,  3.61560702e-02,
                   4.38051058e-03, -2.27254162e-02,  6.02269708e-02, -8.25422251e-03,
                   1.60911231e-02,  8.20251517e-03, -1.53541126e-02,  2.83871598e-02,
                   3.51250224e-02,  2.21395267e-02,  1.97131292e-02,  3.12389563e-02,
                  -4.04803829e-02, -1.55783552e-02,  1.37946306e-02, -2.28218585e-02,
                   1.88738417e-02, -5.28290717e-03,  1.74284676e-04,  1.42351872e-02,
                  -1.18056093e-02, -2.46615912e-02,  1.50880350e-02,  2.39569360e-02,
                  -2.95671096e-03, -1.24320841e-02,  4.04398200e-02, -1.84113974e-02,
                   3.29002788e-03,  4.63591720e-02, -1.16699510e-02, -4.36484791e-02,
                   8.28061848e-03, -1.47116059e-02, -7.37976335e-03, -1.22744818e-02,
                  -2.36785444e-02, -1.24682628e-02,  1.97120140e-02, -4.65012149e-02,
                   1.58231678e-02,  2.44412250e-02, -1.36175951e-02, -2.36894386e-02,
                  -5.35841360e-03, -1.46069717e-02, -2.20745145e-02,  1.92225305e-02,
                  -5.00757470e-02, -1.17423477e-02, -1.52696486e-02, -1.17762733e-03,
                  -2.41975733e-02,  3.84465348e-03,  3.78008001e-02, -3.81623515e-02,
                   2.95398712e-02,  4.38112016e-03, -1.60265568e-03, -2.24580574e-02,
                  -1.28164244e-02,  5.33992977e-03, -1.89984318e-02,  2.28381118e-02,
                  -1.57653200e-03, -7.92323342e-03, -1.30646987e-02, -1.37806904e-02,
                  -1.72680624e-02,  1.35946328e-02,  1.97880603e-02, -2.23424237e-02,
                  -2.79242265e-02,  1.97729954e-03,  2.34071100e-02, -1.78186962e-02,
                   6.49420233e-03, -9.87535594e-03, -1.17098515e-03, -2.73967637e-03,
                  -1.78628259e-02, -2.16182243e-02, -1.89060538e-02,  1.40620416e-03,
                  -1.99170155e-02, -4.83192396e-03, -2.73146497e-02, -2.49753894e-02,
                   1.86954984e-03, -2.71024843e-02,  5.14920765e-03, -2.10423549e-02,
                  -2.49907497e-02, -9.03119154e-03,  3.49963617e-03, -3.56601732e-03,
                  -2.46179481e-02, -9.00493093e-03,  4.04558026e-03, -8.29671817e-03,
                   6.75209629e-03, -4.14147905e-02,  4.19546518e-02, -1.97779846e-02,
                   6.60790801e-03,  7.73632349e-03,  2.13663292e-02,  1.05977387e-02,
                   2.31479890e-02, -1.16423200e-02, -5.39902841e-03,  2.61513948e-02]], dtype=theano.config.floatX)

assert (np.nan != t_f(test)).all()
